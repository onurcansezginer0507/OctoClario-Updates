}
} else if(is.na(result_tb_list_11[[i]]$peak_2[j]) == TRUE && names(result_tb_list_11)[i] == "FV-LEI"){
if(result_tb_list_11[[i]]$min_dips[j] < fv_melt[1] && result_tb_list_11[[i]]$max_dips[j] > fv_melt[2]) {
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
} else {
result_tb_list_11[[i]]$Tm[j] <- data_list_11[[names(result_tb_list_11[i])]][which(data_list_11[[names(result_tb_list_11[i])]][,j+1] %in% result_tb_list_11[[i]]$peak_1),1]
}
} else if(is.na(result_tb_list_11[[i]]$peak_2[j]) == TRUE && names(result_tb_list_11)[i] == "FII"){
if(result_tb_list_11[[i]]$min_dips[j] < fii_melt[1]+1 && result_tb_list_11[[i]]$max_dips[j] > fii_melt[2]) {
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
} else {
result_tb_list_11[[i]]$Tm[j] <- data_list_11[[names(result_tb_list_11[i])]][which(data_list_11[[names(result_tb_list_11[i])]][,j+1] %in% result_tb_list_11[[i]]$peak_1),1]
}
}  else if(is.na(result_tb_list_11[[i]]$peak_2[j]) == TRUE && names(result_tb_list_11)[i] == "FXIII"){
if(result_tb_list_11[[i]]$min_dips[j] < fxiii_melt[1]+1 && result_tb_list_11[[i]]$max_dips[j] > fxiii_melt[2]-1) {
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
} else {
result_tb_list_11[[i]]$Tm[j] <- data_list_11[[names(result_tb_list_11[i])]][which(data_list_11[[names(result_tb_list_11[i])]][,j+1] %in% result_tb_list_11[[i]]$peak_1),1]
}
} else if(is.na(result_tb_list_11[[i]]$peak_2[j]) == TRUE && names(result_tb_list_11)[i] == "FV CAMB"){
if(result_tb_list_11[[i]]$min_dips[j] < fvcamb_melt[1]+1 && result_tb_list_11[[i]]$max_dips[j] > fvcamb_melt[2]-1) {
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
} else {
result_tb_list_11[[i]]$Tm[j] <- data_list_11[[names(result_tb_list_11[i])]][which(data_list_11[[names(result_tb_list_11[i])]][,j+1] %in% result_tb_list_11[[i]]$peak_1),1]
}
}
else {
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
}
}
for (j in 1:nrow(result_tb_list_11[[i]])) {
if (is.na(result_tb_list_11[[i]]$Tm[j])) {
result_tb_list_11[[i]]$genotype[j] <- "No Peaks Detected Within the Boundaries."
} else if ("NTC" %in% well_info$Content[which(well_info$Well %in% rownames(result_tb_list_11[[i]])[j])]){
result_tb_list_11[[i]]$genotype[j] <- "NTC"
} else if ("Positive Control" %in% well_info$Content[which(well_info$Well %in% rownames(result_tb_list_11[[i]])[j])]){
result_tb_list_11[[i]]$genotype[j] <- "Positive Control"
} else if (result_tb_list_11[[i]]$genotype[j] == "Heterozygous" && names(result_tb_list_11[i]) == "ACE"){
result_tb_list_11[[i]]$genotype[j] <- "INS-DEL"
} else if (result_tb_list_11[[i]]$Tm[j] > tm && names(result_tb_list_11[i]) == "ACE"){
result_tb_list_11[[i]]$genotype[j] <- "DEL-DEL"
} else if (result_tb_list_11[[i]]$Tm[j] < tm && names(result_tb_list_11[i]) == "ACE"){
result_tb_list_11[[i]]$genotype[j] <- "INS-INS"
} else if ( result_tb_list_11[[i]]$genotype[j] == "Heterozygous"){
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
} else if (result_tb_list_11[[i]]$Tm[j] > tm && names(result_tb_list_11[i]) != "A1298C"){
result_tb_list_11[[i]]$genotype[j] <- "Wild Type"
} else if (result_tb_list_11[[i]]$Tm[j] < tm && names(result_tb_list_11[i]) != "A1298C"){
result_tb_list_11[[i]]$genotype[j] <- "Homozygous Mutant"
} else if (result_tb_list_11[[i]]$Tm[j] > tm && names(result_tb_list_11[i]) == "A1298C"){
result_tb_list_11[[i]]$genotype[j] <- "Homozygous Mutant"
} else if (result_tb_list_11[[i]]$Tm[j] < tm && names(result_tb_list_11[i]) == "A1298C"){
result_tb_list_11[[i]]$genotype[j] <- "Wild Type"
}
}
}
} else {
result_tb_list_11 <- list()
}
View(result_tb_list_11[["FV CAMB"]])
##for two peak 11 parameter
if(nrow(list2DF(result_tb_list_11)) != 0){
for (i in 1:length(result_tb_list_11)) {
for (j in 1:nrow(result_tb_list_11[[i]])) {
for (k in 1:nrow(well_list_11[[i]])) {
if(rownames(result_tb_list_11[[i]])[j] == well_list_11[[i]]$Well[k]){
result_tb_list_11[[i]]$patient[j] <- well_list_11[[i]]$Sample[k]
}
}
}
}
for (i in 1:length(data_list_11)) {
all_peak <- c()
min_dips <- c()
max_dips <- c()
true_peak_rfu <- c()
melt_range <- melt_list_cvd[[names(data_list_11)[i]]]
lower_bound <- melt_range[1] - 3
upper_bound <- melt_range[2] + 3
for (j in 2:ncol(data_list_11[[i]])) {
if (max(data_list_11[[i]][,j]) < 0) {
min_dips <- c(min_dips, NA)
max_dips <- c(max_dips, NA)
} else {
min_dips <- c(min_dips, min(data_list_11[[i]][which(data_list_11[[i]][,j] > max(data_list_11[[i]][,j]/2)),1]))
max_dips <- c(max_dips, max(data_list_11[[i]][which(data_list_11[[i]][,j] > max(data_list_11[[i]][,j]/2)),1]))
}
for (k in 2:nrow(data_list_11[[i]]-1)) {
if(max(data_list_11[[i]][,j]) > 0){
if(data_list_11[[i]][k,1] > lower_bound && data_list_11[[i]][k,1] < upper_bound){
if (data_list_11[[i]][k+1,j] < data_list_11[[i]][k,j] && data_list_11[[i]][k-1,j] < data_list_11[[i]][k,j]) {
all_peak <- c(all_peak, data_list_11[[i]][k,j])
}
}
} else {
all_peak <- c(all_peak, 0)
}
}
true_peak_rfu <- sort(all_peak, decreasing = TRUE)
if (length(true_peak_rfu) == 0) {
result_tb_list_11[[i]]$peak_1[j-1] <- NA
} else {
result_tb_list_11[[i]]$peak_1[j-1] <- true_peak_rfu[1]
}
if (length(true_peak_rfu) > 1) {
if (true_peak_rfu[2] > true_peak_rfu[1]/3) {
result_tb_list_11[[i]]$peak_2[j-1] <- true_peak_rfu[2]
}
else {
result_tb_list_11[[i]]$peak_2[j-1] <- NA
}
} else {
result_tb_list_11[[i]]$peak_2[j-1] <- NA
}
all_peak <- c()
true_peak_rfu <- c()
}
result_tb_list_11[[i]]$min_dips <- min_dips
result_tb_list_11[[i]]$max_dips <- max_dips
}
for (i in 1:length(result_tb_list_11)) {
tm <- (melt_for_11[[names(result_tb_list_11)[i]]])
for (j in 1:nrow(result_tb_list_11[[i]])) {
if ("NTC" %in% well_info$Content[which(well_info$Well %in% rownames(result_tb_list_11[[i]])[j])]) {
result_tb_list_11[[i]]$genotype[j] <- "NTC"
next
}
if ("Positive Control" %in% well_info$Content[which(well_info$Well %in% rownames(result_tb_list_11[[i]])[j])]){
result_tb_list_11[[i]]$genotype[j] <- "Positive Control"
next
}
if (is.na(result_tb_list_11[[i]]$min_dips[j]) && is.na(result_tb_list_11[[i]]$max_dips[j])) {
result_tb_list_11[[i]]$Tm[j] <- NA
next
}
if (is.na(result_tb_list_11[[i]]$peak_2[j]) && names(result_tb_list_11)[i] %!in% c("HPAI", "FV-LEI", "FII", "FV CAMB")) {
result_tb_list_11[[i]]$Tm[j] <- as.numeric(data_list_11[[names(result_tb_list_11[i])]][which(data_list_11[[names(result_tb_list_11[i])]][,j+1] %in% result_tb_list_11[[i]]$peak_1),1])
} else if (is.na(result_tb_list_11[[i]]$peak_2[j]) == TRUE && names(result_tb_list_11)[i] == "HPAI"){
if(result_tb_list_11[[i]]$min_dips[j] < hpai_melt[1] && result_tb_list_11[[i]]$max_dips[j] > hpai_melt[2]) {
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
} else {
result_tb_list_11[[i]]$Tm[j] <- data_list_11[[names(result_tb_list_11[i])]][which(data_list_11[[names(result_tb_list_11[i])]][,j+1] %in% result_tb_list_11[[i]]$peak_1),1]
}
} else if(is.na(result_tb_list_11[[i]]$peak_2[j]) == TRUE && names(result_tb_list_11)[i] == "FV-LEI"){
if(result_tb_list_11[[i]]$min_dips[j] < fv_melt[1] && result_tb_list_11[[i]]$max_dips[j] > fv_melt[2]) {
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
} else {
result_tb_list_11[[i]]$Tm[j] <- data_list_11[[names(result_tb_list_11[i])]][which(data_list_11[[names(result_tb_list_11[i])]][,j+1] %in% result_tb_list_11[[i]]$peak_1),1]
}
} else if(is.na(result_tb_list_11[[i]]$peak_2[j]) == TRUE && names(result_tb_list_11)[i] == "FII"){
if(result_tb_list_11[[i]]$min_dips[j] < fii_melt[1]+1 && result_tb_list_11[[i]]$max_dips[j] > fii_melt[2]) {
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
} else {
result_tb_list_11[[i]]$Tm[j] <- data_list_11[[names(result_tb_list_11[i])]][which(data_list_11[[names(result_tb_list_11[i])]][,j+1] %in% result_tb_list_11[[i]]$peak_1),1]
}
}  else if(is.na(result_tb_list_11[[i]]$peak_2[j]) == TRUE && names(result_tb_list_11)[i] == "FXIII"){
if(result_tb_list_11[[i]]$min_dips[j] < fxiii_melt[1]+1 && result_tb_list_11[[i]]$max_dips[j] > fxiii_melt[2]-1) {
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
} else {
result_tb_list_11[[i]]$Tm[j] <- data_list_11[[names(result_tb_list_11[i])]][which(data_list_11[[names(result_tb_list_11[i])]][,j+1] %in% result_tb_list_11[[i]]$peak_1),1]
}
} else if(is.na(result_tb_list_11[[i]]$peak_2[j]) == TRUE && names(result_tb_list_11)[i] == "FV CAMB"){
if(result_tb_list_11[[i]]$min_dips[j] < fvcamb_melt[1]+1 && result_tb_list_11[[i]]$max_dips[j] > fvcamb_melt[2]-1) {
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
} else {
result_tb_list_11[[i]]$Tm[j] <- data_list_11[[names(result_tb_list_11[i])]][which(data_list_11[[names(result_tb_list_11[i])]][,j+1] %in% result_tb_list_11[[i]]$peak_1),1]
}
}
else {
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
}
}
for (j in 1:nrow(result_tb_list_11[[i]])) {
if (is.na(result_tb_list_11[[i]]$Tm[j])) {
result_tb_list_11[[i]]$genotype[j] <- "No Peaks Detected Within the Boundaries."
} else if ("NTC" %in% well_info$Content[which(well_info$Well %in% rownames(result_tb_list_11[[i]])[j])]){
result_tb_list_11[[i]]$genotype[j] <- "NTC"
} else if ("Positive Control" %in% well_info$Content[which(well_info$Well %in% rownames(result_tb_list_11[[i]])[j])]){
result_tb_list_11[[i]]$genotype[j] <- "Positive Control"
} else if (result_tb_list_11[[i]]$genotype[j] == "Heterozygous" && names(result_tb_list_11[i]) == "ACE"){
result_tb_list_11[[i]]$genotype[j] <- "INS-DEL"
} else if (result_tb_list_11[[i]]$Tm[j] > tm && names(result_tb_list_11[i]) == "ACE"){
result_tb_list_11[[i]]$genotype[j] <- "DEL-DEL"
} else if (result_tb_list_11[[i]]$Tm[j] < tm && names(result_tb_list_11[i]) == "ACE"){
result_tb_list_11[[i]]$genotype[j] <- "INS-INS"
} else if ( result_tb_list_11[[i]]$genotype[j] == "Heterozygous"){
result_tb_list_11[[i]]$genotype[j] <- "Heterozygous"
} else if (result_tb_list_11[[i]]$Tm[j] > tm && names(result_tb_list_11[i]) != "A1298C"){
result_tb_list_11[[i]]$genotype[j] <- "Wild Type"
} else if (result_tb_list_11[[i]]$Tm[j] < tm && names(result_tb_list_11[i]) != "A1298C"){
result_tb_list_11[[i]]$genotype[j] <- "Homozygous Mutant"
} else if (result_tb_list_11[[i]]$Tm[j] > tm && names(result_tb_list_11[i]) == "A1298C"){
result_tb_list_11[[i]]$genotype[j] <- "Homozygous Mutant"
} else if (result_tb_list_11[[i]]$Tm[j] < tm && names(result_tb_list_11[i]) == "A1298C"){
result_tb_list_11[[i]]$genotype[j] <- "Wild Type"
}
}
}
} else {
result_tb_list_11 <- list()
}
View(result_tb_list_11[["FV CAMB"]])
fvcamb_melt
halfmax_fwhm(fvcamb_data[,1], fvcamb_data[,11])
View(halfmax_fwhm(fvcamb_data[,1], fvcamb_data[,11]))
View(na.omit(halfmax_fwhm(fvcamb_data[,1], fvcamb_data[,11])))
View(na.omit(halfmax_fwhm(fvcamb_data[,1], fvcamb_data[,10])))
View(na.omit(halfmax_fwhm(fvcamb_data[,1], fvcamb_data[,9])))
View(na.omit(halfmax_fwhm(fvcamb_data[,1], fvcamb_data[,8])))
View(na.omit(halfmax_fwhm(fvcamb_data[,1], fvcamb_data[,7])))
View(na.omit(halfmax_fwhm(fvcamb_data[,1], a1298_data[,10])))
View(na.omit(halfmax_fwhm(fvcamb_data[,1], a1298_data[,9])))
View(na.omit(halfmax_fwhm(fvcamb_data[,1], fvcamb_data[,10])))
fvcamb_melt
View(result_tb_list_11)
View(result_tb_list_11[["FV CAMB"]])
View(fvcamb_data)
fvcamb_data[,"w32"]
rownames(result_tb_list_11)
rownames(result_tb_list_11[[9]])
rownames(result_tb_list_11[[9]][2])
rownames(result_tb_list_11[[9]][3])
rownames(result_tb_list_11[[9]])[2]
edges <- na.omit(halfmax_fwhm(fvcamb_data[,1], fvcamb_data[,rownames(result_tb_list_11[[i]])[j]]))
edges <- halfmax_fwhm(fvcamb_data[,1], fvcamb_data[,"w34"])
edges <- edges[edges$peak_T > fvcamb_melt[1]-2,]
edges
edges$left_half_T
edges$right_half_T
fvcamb_data
edges$right_half_T
edges$left_half_T
fvcamb_melt
edges <- halfmax_fwhm(fvcamb_data[,1], fvcamb_data[,11])
edges <- na.omit(edges)
edges$left_half_T
edges$right_half_T
edges$FWHM
edges2 <- halfmax_fwhm(fvcamb_data[,1], fvcamb_data[,10])
edges2$FWHM
edges2$FWHM
View(edge2)
View(edges2)
View(edges)
write.csv(fvcamb_data, "undefined_peaks.csv")
# ------------------------------------------------------------
# Shoulder-aware peak detection via 2nd derivative (base R)
# ------------------------------------------------------------
detect_peaks_2nd <- function(
x, y,
window_min = -Inf, window_max = Inf,  # e.g., 35, 85
spar_signal = 0.35,                   # smoothing (0.30–0.55 typical)
min_sep_deg = 1.0,                    # min separation (°C) between curvature minima
abs_curv_thresh = NA,                 # absolute |d2| threshold (set NA to auto-scale)
rel_curv_thresh = 0.15,               # if abs_curv_thresh=NA, require |d2| >= rel * max(|d2|)
refine_zero_window_deg = 1.5          # search ±°C around curvature min for dy=0
){
stopifnot(length(x) == length(y))
ok <- is.finite(x) & is.finite(y)
x  <- x[ok]; y <- y[ok]
o  <- order(x); x <- x[o]; y <- y[o]
# restrict to analysis window
wmask <- (x >= window_min) & (x <= window_max)
xw <- x[wmask]; yw <- y[wmask]
if (length(xw) < 5) {
return(list(class="insufficient_data", peaks_T=numeric(0),
details=data.frame()))
}
# smooth signal
ys <- stats::predict(stats::smooth.spline(xw, yw, spar = spar_signal), xw)$y
# derivatives from a natural spline of the smoothed curve
sf  <- stats::splinefun(xw, ys, method = "natural")
dy  <- sf(xw, deriv = 1)
d2y <- sf(xw, deriv = 2)
# candidate curvature minima (negative lobes)
n <- length(xw)
idx_min <- which(d2y[-c(1,n)] < d2y[-c(1,2)] & d2y[-c(n-1,n)] < d2y[-c(1,n-1)]) + 1L
if (!length(idx_min)) {
# fall back: just report the main apex of ys
pi <- which.max(ys)
return(list(class="single", peaks_T = xw[pi],
details = data.frame(Tm = xw[pi], source="apex", d2 = d2y[pi])))
}
# magnitude threshold
if (is.na(abs_curv_thresh)) {
abs_curv_thresh <- rel_curv_thresh * max(abs(d2y), na.rm = TRUE)
}
cand <- idx_min[d2y[idx_min] <= -abs_curv_thresh]
if (!length(cand)) {
pi <- which.max(ys)
return(list(class="single", peaks_T = xw[pi],
details = data.frame(Tm = xw[pi], source="apex", d2 = d2y[pi])))
}
# enforce °C separation (greedy by magnitude)
ord <- order(d2y[cand]) # most negative first
cand <- cand[ord]
keep <- integer(0)
idx_per_deg <- mean(diff(seq_len(n)) / diff(xw))
min_sep_idx <- max(1L, floor(min_sep_deg * idx_per_deg))
for (i in cand) {
if (!length(keep) || all(abs(i - keep) >= min_sep_idx)) keep <- c(keep, i)
}
# refine each curvature cue to a nearby dy==0 (true apex) if it exists
refine_to_zero <- function(i){
x0 <- xw[i]
rng <- which(abs(xw - x0) <= refine_zero_window_deg)
if (length(rng) < 3) return(i)
# zero crossing of dy within rng
s <- sign(dy[rng]); s[s == 0] <- NA
zc <- which(head(s, -1) > 0 & tail(s, -1) < 0)  # + to -
if (length(zc)) {
j <- rng[zc[1]]          # index of left point of crossing
# linear interpolation on dy to estimate temperature of zero
a <- dy[j]; b <- dy[j+1]
t <- if (b == a) 0 else -a / (b - a)
x_ref <- xw[j] + t * (xw[j+1] - xw[j])
# map temperature back to nearest index for returning Tm precisely
return(which.min(abs(xw - x_ref)))
}
i
}
refined <- unique(sapply(keep, refine_to_zero))
Tm_candidates <- xw[refined]
# choose classification
class <- if (length(Tm_candidates) >= 2) "double" else "single"
# return details
det <- data.frame(
Tm    = xw[refined],
d2    = d2y[refined],
source= "2nd-deriv"
)
# ensure the main apex is included for completeness
main_idx <- which.max(ys)
if (!any(abs(det$Tm - xw[main_idx]) < 1e-6)) {
det <- rbind(det, data.frame(Tm = xw[main_idx], d2 = d2y[main_idx], source = "apex"))
}
det <- det[order(det$Tm), ]
list(class = class, peaks_T = det$Tm, details = det,
aux = list(x = xw, ys = ys, dy = dy, d2y = d2y))
}
detect_peaks_2nd(fvcamb_data[,1], y = fvcamb_data[,11], window_min = 35, window_max = 85)
asdf <- detect_peaks_2nd(fvcamb_data[,1], y = fvcamb_data[,11], window_min = 35, window_max = 85)
View(asdf)
asdf$class
asdf <- detect_peaks_2nd(fvcamb_data[,1], y = fvcamb_data[,10], window_min = 35, window_max = 85)
asdf
View(asdf)
asdf <- detect_peaks_2nd(fvcamb_data[,1], y = fvcamb_data[,10], window_min = 35, window_max = 85)
View(asdf)
asdf <- detect_peaks_2nd(fvcamb_data[,1], y = fvcamb_data[,2], window_min = 35, window_max = 85)
asdf <- detect_peaks_2nd(x = fvcamb_data[,1], y = fvcamb_data[,2], window_min = 35, window_max = 85)
asdf <- detect_peaks_2nd(x = fvcamb_data[,1], y = fvcamb_data[,2], window_min = 60, window_max = 70)
asdf <- detect_peaks_2nd(x = fvcamb_data[,1], y = fvcamb_data[,2], window_min = 60, window_max = 70, spar_signal = 0.35, min_sep_deg = 0.8, abs_curv_thresh = NA, rel_curv_thresh = 0.15, refine_zero_window_deg = 1.5)
asdf <- detect_peaks_2nd(x = fvcamb_data[,1], y = fvcamb_data[,11], window_min = 60, window_max = 70, spar_signal = 0.35, min_sep_deg = 0.8, abs_curv_thresh = NA, rel_curv_thresh = 0.15, refine_zero_window_deg = 1.5)
asdf <- detect_peaks_2nd(x = fvcamb_data[,1], y = fvcamb_data[,2], window_min = 60, window_max = 70, spar_signal = 0.35, min_sep_deg = 0.8, abs_curv_thresh = NA, rel_curv_thresh = 0.15, refine_zero_window_deg = 1.5)
# Shoulder-aware peak detection via 2nd derivative (base R)
# ------------------------------------------------------------
# ------------------------------------------------------------
# ROI-gated 2nd-derivative peak detector with proximity merge
# base R (smooth.spline + splinefun)
# ------------------------------------------------------------
# ------------------------------------------------------------
# ROI-gated 2nd-derivative peak detector with proximity merge
# base R (smooth.spline + splinefun)
# ------------------------------------------------------------
detect_peaks_2nd_roi <- function(
x, y,
roi_min = 60, roi_max = 70,     # hard window; nothing outside can be detected
spar_signal = 0.35,             # smoothing (0.30–0.55 typical)
rel_curv_thresh = 0.18,         # keep minima with |d2| >= rel * max(|d2|) in ROI
abs_curv_thresh = NA,           # or set an absolute threshold; NA = auto via rel
merge_close_deg = 1.0,          # merge minima/refined Tm closer than this
min_sep_deg = 1.2,              # final required separation for calling "double"
refine_zero_window_deg = 1.5,   # ±°C search around curvature min for dy=0
max_peaks = 2                   # cap number of peaks reported
){
stopifnot(length(x) == length(y))
ok <- is.finite(x) & is.finite(y)
x <- x[ok]; y <- y[ok]
o <- order(x); x <- x[o]; y <- y[o]
# --- ROI gating
m <- x >= roi_min & x <= roi_max
if (!any(m)) return(list(class="none_in_roi", peaks_T=numeric(0),
details=data.frame()))
xw <- x[m]; yw <- y[m]
if (length(xw) < 5) return(list(class="insufficient_data", peaks_T=numeric(0),
details=data.frame()))
# --- smooth + derivatives
ys <- predict(smooth.spline(xw, yw, spar = spar_signal), xw)$y
sf  <- splinefun(xw, ys, method = "natural")
dy  <- sf(xw, deriv = 1)
d2y <- sf(xw, deriv = 2)
# --- candidate curvature minima inside ROI (strictly negative lobes)
n <- length(xw)
idx_min <- which(d2y[-c(1,n)] < d2y[-c(1,2)] & d2y[-c(n-1,n)] < d2y[-c(1,n-1)]) + 1L
if (!length(idx_min)) {
# fallback: main apex within ROI
pi <- which.max(ys)
return(list(class="single", peaks_T=xw[pi],
details=data.frame(Tm=xw[pi], d2=d2y[pi], source="apex")))
}
# --- magnitude threshold
if (is.na(abs_curv_thresh)) abs_curv_thresh <- rel_curv_thresh * max(abs(d2y), na.rm=TRUE)
cand <- idx_min[d2y[idx_min] <= -abs_curv_thresh]
if (!length(cand)) {
pi <- which.max(ys)
return(list(class="single", peaks_T=xw[pi],
details=data.frame(Tm=xw[pi], d2=d2y[pi], source="apex")))
}
# helper: °C -> indices
idx_per_deg <- mean(diff(seq_len(n)) / diff(xw))
to_idx <- function(deg) max(1L, floor(deg * idx_per_deg))
# --- refine each min to a nearby dy==0 (true apex) if present
refine_to_zero <- function(i){
rng <- which(abs(xw - xw[i]) <= refine_zero_window_deg)
if (length(rng) < 3) return(i)
s <- sign(dy[rng]); s[s==0] <- NA
zc <- which(head(s,-1) > 0 & tail(s,-1) < 0)  # + to -
if (!length(zc)) return(i)
j <- rng[zc[1]]
a <- dy[j]; b <- dy[j+1]
t <- if (b == a) 0 else -a/(b-a)
x_ref <- xw[j] + t*(xw[j+1]-xw[j])
which.min(abs(xw - x_ref))
}
refined <- vapply(cand, refine_to_zero, 1L)
# --- merge close-by candidates (by temperature distance), keep stronger (more -d2)
merge_idx <- to_idx(merge_close_deg)
keep <- logical(length(refined)); keep[] <- TRUE
ord  <- order(d2y[refined])  # most negative first
chosen <- integer(0)
for (k in ord) {
if (!keep[k]) next
i <- refined[k]
chosen <- c(chosen, i)
# suppress neighbors within merge window
close <- which(abs(refined - i) < merge_idx)
keep[close] <- FALSE
keep[k] <- TRUE
}
refined <- sort(unique(chosen))
# --- enforce final separation
sep_idx <- to_idx(min_sep_deg)
final <- integer(0)
for (i in refined) {
if (!length(final) || all(abs(i - final) >= sep_idx)) final <- c(final, i)
}
# limit to max_peaks (prefer strongest curvature)
if (length(final) > max_peaks) {
ord <- order(d2y[final])  # most negative first
final <- final[ord][seq_len(max_peaks)]
final <- sort(final)
}
# if nothing left, fall back to apex in ROI
if (!length(final)) {
pi <- which.max(ys)
return(list(class="single", peaks_T=xw[pi],
details=data.frame(Tm=xw[pi], d2=d2y[pi], source="apex")))
}
class <- if (length(final) >= 2) "double" else "single"
det <- data.frame(Tm = xw[final], d2 = d2y[final], source = "2nd-deriv")
# ensure ROI apex present for reference
main_idx <- which.max(ys)
if (!any(abs(det$Tm - xw[main_idx]) < 1e-6)) {
det <- rbind(det, data.frame(Tm=xw[main_idx], d2=d2y[main_idx], source="apex"))
}
det <- det[order(det$Tm), ]
list(class=class, peaks_T=det$Tm, details=det)
}
remove(detect_peaks_2nd())
remove(detect_peaks_2nd
)
detect_peaks_2nd_roi(fvcamb_data[,1], y = fvcamb_data[,2])
detect_peaks_2nd_roi(fvcamb_data[,1], y = fvcamb_data[,3])
detect_peaks_2nd_roi(fvcamb_data[,1], y = fvcamb_data[,4])
detect_peaks_2nd_roi(fvcamb_data[,1], y = fvcamb_data[,5])
detect_peaks_2nd_roi(fvcamb_data[,1], y = fvcamb_data[,6])
detect_peaks_2nd_roi(fvcamb_data[,1], y = fvcamb_data[,7])
detect_peaks_2nd_roi(fvcamb_data[,1], y = fvcamb_data[,8])
detect_peaks_2nd_roi(fvcamb_data[,1], y = fvcamb_data[,9])
detect_peaks_2nd_roi(fvcamb_data[,1], y = fvcamb_data[,10])
detect_peaks_2nd_roi(fvcamb_data[,1], y = fvcamb_data[,11])
asdf <- detect_peaks_2nd_roi(fvcamb_data[,1], y = fvcamb_data[,"w40"], merge_close_deg = 2.5)
asdf
asdf$class
asdf$class == "double"
j
asdf <- detect_peaks_2nd_roi(x = pai_data[,1], y = pai_data[,3])
asdf
asdf <- detect_peaks_2nd_roi(x = pai_data[,1], y = pai_data[,4])
asdf
asdf <- detect_peaks_2nd_roi(x = pai_data[,1], y = pai_data[,4], merge_close_deg = 0.5)
asdf
detect_peaks_2nd_roi(fv_data[,1], y = fv_data[,2], roi_min = fv_melt[1]-2, roi_max = fv_melt[2]+2)
detect_peaks_2nd_roi(fv_data[,1], y = fv_data[,3], roi_min = fv_melt[1]-2, roi_max = fv_melt[2]+2)
detect_peaks_2nd_roi(fv_data[,1], y = fv_data[,4], roi_min = fv_melt[1]-2, roi_max = fv_melt[2]+2)
detect_peaks_2nd_roi(fv_data[,1], y = fv_data[,5], roi_min = fv_melt[1]-2, roi_max = fv_melt[2]+2)
detect_peaks_2nd_roi(fv_data[,1], y = fv_data[,6], roi_min = fv_melt[1]-2, roi_max = fv_melt[2]+2)
detect_peaks_2nd_roi(fv_data[,1], y = fv_data[,7], roi_min = fv_melt[1]-2, roi_max = fv_melt[2]+2)
detect_peaks_2nd_roi(fv_data[,1], y = fv_data[,8], roi_min = fv_melt[1]-2, roi_max = fv_melt[2]+2)
detect_peaks_2nd_roi(fv_data[,1], y = fv_data[,9], roi_min = fv_melt[1]-2, roi_max = fv_melt[2]+2)
fxiii_melt
hpai_melt
detect_peaks_2nd_roi(fv_data[,1],
fv_data[,8+1],
roi_min = fv_melt[1]-2,
roi_max = fv_melt[2]+2,
merge_close_deg = 2.5, max_peaks = 2)
View(result_tb_list_11)
View(result_tb_list_11[["FV-LEI"]])
1.57/3
getwd()
